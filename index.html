<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jarvis AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
    />

    <style>
      /* Custom styles for the app */
      
      /* Make code blocks look better */
      .prose pre {
        background-color: #1f2937; /* gray-800 */
        color: #f3f4f6; /* gray-100 */
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        position: relative;
      }
      
      /* Style for the "Copy" button on code blocks */
      .copy-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background-color: #374151; /* gray-700 */
        color: #d1d5db; /* gray-300 */
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .prose pre:hover .copy-btn {
        opacity: 1;
      }
      
      .copy-btn:active {
        background-color: #4b5563; /* gray-600 */
      }

      /* Custom scrollbar for webkit browsers */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #111827; /* gray-900 */
      }
      ::-webkit-scrollbar-thumb {
        background: #374151; /* gray-700 */
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #4b5563; /* gray-600 */
      }

      /* CSS Typing Indicator */
      .typing-indicator {
        display: flex;
        align-items: center;
        padding: 0.5rem 0;
      }
      .typing-indicator span {
        height: 8px;
        width: 8px;
        background-color: #6b7280; /* gray-500 */
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: bounce 1.4s infinite both;
      }
      .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
      }
      @keyframes bounce {
        0%, 80%, 100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
    </style>

    <script>
      // Set theme on initial load
      if (
        localStorage.theme === "dark" ||
        (!("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    </script>
  </head>

  <body
    class="bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 flex flex-col h-screen font-sans selection:bg-emerald-500/30 transition-colors duration-300"
  >
    <header
      class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-900/80 backdrop-blur-lg sticky top-0 z-10"
    >
      <h1 class="text-xl font-semibold text-emerald-500 dark:text-emerald-400 tracking-wide flex items-center gap-2">
        ðŸ§  Jarvis AI
      </h1>
      <div class="flex items-center gap-2">
        <button
          id="clear-chat-btn"
          class="text-gray-500 dark:text-gray-400 hover:text-emerald-500 dark:hover:text-emerald-400 transition-colors"
          title="Clear chat"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.502 0A48.097 48.097 0 0 1 9.25 5.397M14.5 5.79a48.108 48.108 0 0 0-3.478-.397m0 0a48.097 48.097 0 0 1-3.478.397m6.956 0C11.13 5.397 9.25 5.397 9.25 5.397" />
          </svg>
        </button>
        <button
          id="theme-toggle"
          class="text-gray-500 dark:text-gray-400 hover:text-emerald-500 dark:hover:text-emerald-400 transition-colors"
          title="Toggle theme"
        >
          <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-6.748Z" />
          </svg>
          <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-6.364-.386 1.591-1.591M3 12h2.25m.386-6.364 1.591 1.591M12 12a2.25 2.25 0 0 1-2.25-2.25A2.25 2.25 0 0 1 12 7.5s0 0 0 0a2.25 2.25 0 0 1 2.25 2.25A2.25 2.25 0 0 1 12 12Z" />
          </svg>
        </button>
      </div>
    </header>

    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
      <div id="welcome-message" class="text-center text-gray-500 dark:text-gray-400 mt-10 italic">
        Ask me anything <span class="text-emerald-500 dark:text-emerald-400">Powered by  llama 3.2:1b</span> ðŸ‘‡
      </div>
    </main>

    <footer
      class="border-t border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-900/80 backdrop-blur-lg p-4"
    >
      <div classs="max-w-4xl mx-auto flex items-center space-x-2">
        <textarea
          id="user-input"
          rows="1"
          placeholder="Type your message..."
          class="flex-1 resize-none bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-xl p-3 outline-none focus:ring-2 focus:ring-emerald-500/50 placeholder-gray-500 dark:placeholder-gray-500"
        ></textarea>
        <button
          id="send-btn"
          class="p-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
          title="Send message"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
          </svg>
        </button>
      </div>
    </footer>

    <script>
      const chatContainer = document.getElementById("chat-container");
      const input = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");
      const themeToggle = document.getElementById("theme-toggle");
      const themeIconMoon = document.getElementById("theme-icon-moon");
      const themeIconSun = document.getElementById("theme-icon-sun");
      const clearChatBtn = document.getElementById("clear-chat-btn");
      const welcomeMessage = document.getElementById("welcome-message");
      
      // Configure marked.js to work with highlight.js
      marked.setOptions({
        highlight: function(code, lang) {
          const language = hljs.getLanguage(lang) ? lang : 'plaintext';
          return hljs.highlight(code, { language }).value;
        },
        langPrefix: 'hljs language-', // Use 'hljs' class prefix
        gfm: true,
        breaks: true,
      });

      // Update with your ngrok or backend URL
      const API_URL = "https://v2-portfolio-kzqv.onrender.com/ask";

      // --- Helper Functions ---

      // Toggles the theme icon
      function updateThemeIcon(isDark) {
        if (isDark) {
          themeIconMoon.classList.add("hidden");
          themeIconSun.classList.remove("hidden");
        } else {
          themeIconMoon.classList.remove("hidden");
          themeIconSun.classList.add("hidden");
        }
      }

      // Adds the "Copy" button functionality to code blocks
      function addCopyButtons(element) {
        element.querySelectorAll('pre').forEach((pre) => {
          const code = pre.querySelector('code');
          if (!code) return;

          const btn = document.createElement('button');
          btn.className = 'copy-btn';
          btn.textContent = 'Copy';
          
          btn.addEventListener('click', () => {
            navigator.clipboard.writeText(code.innerText);
            btn.textContent = 'Copied!';
            setTimeout(() => {
              btn.textContent = 'Copy';
            }, 2000);
          });
          
          pre.appendChild(btn);
        });
      }

      // Append message to chat
      function appendMessage(sender, text, isLoading = false) {
        // Hide welcome message on first message
        if (welcomeMessage) {
          welcomeMessage.style.display = 'none';
        }

        const msg = document.createElement("div");
        msg.classList.add("p-3", "rounded-xl", "max-w-3xl", "mx-auto", "w-full");

        if (sender === "user") {
          msg.classList.add("bg-emerald-600/20", "text-gray-900", "dark:text-gray-100", "self-end", "break-words");
          msg.innerHTML = `<strong class="text-emerald-600 dark:text-emerald-400">You:</strong><div class="whitespace-pre-wrap mt-1">${text}</div>`;
        } else if (isLoading) {
          msg.classList.add("bg-gray-100", "dark:bg-gray-800", "text-gray-900", "dark:text-gray-200");
          msg.innerHTML = `
            <strong class="text-emerald-600 dark:text-emerald-400">AI:</strong>
            <div class="typing-indicator">
              <span></span><span></span><span></span>
            </div>`;
          msg.id = "loading-indicator"; // Give it an ID to find it later
        } else {
          msg.classList.add("bg-gray-100", "dark:bg-gray-800", "text-gray-900", "dark:text-gray-200", "prose", "prose-sm", "dark:prose-invert");
          
          // Parse Markdown and sanitize
          const renderedHtml = marked.parse(text);
          msg.innerHTML = `<strong class="text-emerald-600 dark:text-emerald-400">AI:</strong> ${renderedHtml}`;
          
          // Add copy buttons to new code blocks
          addCopyButtons(msg);
        }

        chatContainer.appendChild(msg);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Handle sending message
      async function sendMessage() {
        const prompt = input.value.trim();
        if (!prompt) return;

        appendMessage("user", prompt);
        input.value = "";
        input.style.height = 'auto'; // Reset textarea height
        sendBtn.disabled = true;

        appendMessage("bot", "", true); // Show loading indicator

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt }),
          });

          const data = await response.json();
          
          // Remove "Thinking..."
          document.getElementById("loading-indicator")?.remove();
          
          appendMessage("bot", data.response || "âš ï¸ No response received.");
        } catch (error) {
          document.getElementById("loading-indicator")?.remove();
          appendMessage("bot", "âŒ Failed to connect to server. Please ensure the backend is running.");
          console.error(error);
        } finally {
          sendBtn.disabled = false;
          input.focus();
        }
      }

      // --- Event Listeners ---

      // Send button click
      sendBtn.addEventListener("click", sendMessage);

      // Enter key press in input
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // Auto-resize textarea
      input.addEventListener('input', () => {
        input.style.height = 'auto';
        input.style.height = (input.scrollHeight) + 'px';
      });

      // Theme toggle
      themeToggle.addEventListener("click", () => {
        const html = document.documentElement;
        const isDark = html.classList.toggle("dark");
        localStorage.theme = isDark ? "dark" : "light";
        updateThemeIcon(isDark);
      });
      
      // Clear chat button
      clearChatBtn.addEventListener("click", () => {
        chatContainer.innerHTML = ''; // Clear all messages
        chatContainer.appendChild(welcomeMessage); // Add back the welcome message
        welcomeMessage.style.display = 'block'; // Make it visible again
      });

      // --- Initial Setup ---

      // Set initial theme icon
      updateThemeIcon(document.documentElement.classList.contains("dark"));

      // Set initial textarea height
      input.style.height = (input.scrollHeight) + 'px';
    </script>
  </body>
</html>